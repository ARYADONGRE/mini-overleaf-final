<!DOCTYPE html>
<html>
<head>
    <title>Editor - {{ project.name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; }
        #sidebar { width: 260px; background: #f0f2f5; border-right: 1px solid #ccc; padding: 12px; display: flex; flex-direction: column; flex-shrink: 0; }
        .section-label { font-size: 11px; font-weight: bold; color: #555; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;}
        .btn { padding: 8px; border: none; cursor: pointer; border-radius: 4px; color: white; font-size: 13px; width: 100%; margin-bottom: 8px; font-weight: 500;}
        .btn-blue { background: #007bff; } .btn-gray { background: #6c757d; } .btn-red { background: #dc3545; width: auto; padding: 2px 6px; font-size: 10px; margin-left: auto; cursor: pointer;}
        select { width: 100%; padding: 6px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; background: white;}
        input[type="file"] { display: none; }
        #file-list { margin-top: 10px; font-size: 13px; color: #333; overflow-y: auto; flex-grow: 1; border-top: 1px solid #ccc; padding-top: 5px; background: white; border-radius: 4px;}
        .file-item { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
        .file-item:hover { background: #eef2ff; }
        .file-icon { margin-right: 8px; width: 16px; text-align: center;}
        .gutter { width: 8px; cursor: col-resize; background: #e0e0e0; border-left: 1px solid #ccc; border-right: 1px solid #ccc; flex-shrink: 0; }
        #editor-container { flex-grow: 1; display: flex; flex-direction: column; width: 50%; min-width: 200px; }
        #preview-container { flex-grow: 1; display: flex; flex-direction: column; width: 50%; min-width: 200px; background: #555; }
        #toolbar { padding: 10px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; }
        .CodeMirror { flex-grow: 1; font-size: 14px; }
        iframe { width: 100%; height: 100%; border: none; background: white; flex-grow: 1; }
        #error-box { background: #dc3545; color: white; padding: 10px; display: none; font-size: 13px; }
        .error-line { background-color: #f8d7da !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <a href="/dashboard" style="margin-bottom:15px; display:block; color:#007bff; text-decoration:none;">&larr; Back to Dashboard</a>
        <div class="section-label">1. Destination Folder</div>
        <select id="folder-select"><option value="">(Root)</option></select>

        <div class="section-label">2. Actions</div>
        <div style="display: flex; gap: 5px;">
            <button class="btn btn-gray" onclick="createFolder()">+ Folder</button>
            <button class="btn btn-blue" onclick="document.getElementById('img-upload').click()">Upload</button>
        </div>
        <input type="file" id="img-upload" multiple onchange="uploadFiles()">

        <div class="section-label" style="margin-top: 10px;">{{ project.name }}</div>
        <div id="file-list"></div>
    </div>

    <div id="editor-container">
        <div id="toolbar">
            <span>Editor</span>
            <button class="btn btn-blue" style="background: #28a745; width: auto; margin-bottom:0;" id="compile-btn" onclick="compile()">Recompile</button>
        </div>
        <div id="error-box"></div>
        <textarea id="code">{{ code }}</textarea>
    </div>
    <div class="gutter" id="gutter"></div>
    <div id="preview-container"><iframe id="preview"></iframe></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>

    <script>
        const projectId = {{ project.id }}; 

        // Resizer Logic
        const gutter = document.getElementById('gutter');
        const leftPanel = document.getElementById('editor-container');
        gutter.addEventListener('mousedown', function(e) {
            e.preventDefault();
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });
        function resize(e) {
            const newWidth = e.clientX - 260; 
            if (newWidth > 100 && newWidth < window.innerWidth - 300) leftPanel.style.width = newWidth + 'px';
        }
        function stopResize() {
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            lineNumbers: true, mode: "stex", lineWrapping: true
        });

        async function refreshFileList() {
            try {
                const res = await fetch(`/files/${projectId}`);
                const files = await res.json();
                const list = document.getElementById('file-list');
                const select = document.getElementById('folder-select');
                const currentSelection = select.value;
                
                list.innerHTML = "";
                select.innerHTML = '<option value="">(Root)</option>';
                
                files.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    let icon = 'üìÑ';
                    if (f.type === 'folder') {
                        icon = 'üìÇ';
                        const opt = document.createElement('option');
                        opt.value = f.path; opt.innerText = f.path;
                        select.appendChild(opt);
                    } else if (f.path.match(/\.(png|jpg|jpeg)$/)) icon = 'üñºÔ∏è';

                    div.innerHTML = `<span class="file-icon">${icon}</span> <span style="flex-grow:1;">${f.path}</span> <button class="btn-red" onclick="deleteItem('${f.path}')">x</button>`;
                    list.appendChild(div);
                });
                select.value = currentSelection;
            } catch(e) {}
        }

        async function createFolder() {
            const name = prompt("Folder name:");
            if (!name) return;
            await fetch('/create_folder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project_id: projectId, folder_name: name})
            });
            refreshFileList();
        }

        async function deleteItem(path) {
            if (!confirm(`Delete ${path}?`)) return;
            await fetch('/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project_id: projectId, path: path})
            });
            refreshFileList();
        }

        async function uploadFiles() {
            const input = document.getElementById('img-upload');
            const target = document.getElementById('folder-select').value;
            const formData = new FormData();
            formData.append('project_id', projectId);
            formData.append('target_folder', target);
            for (let i = 0; i < input.files.length; i++) formData.append('file', input.files[i]);

            const btn = document.querySelector('.btn-blue');
            const txt = btn.innerText; btn.innerText = "..."; btn.disabled = true;
            await fetch('/upload', { method: 'POST', body: formData });
            input.value = ""; btn.innerText = txt; btn.disabled = false;
            refreshFileList();
        }

        async function compile() {
            const btn = document.getElementById("compile-btn");
            const errBox = document.getElementById("error-box");
            btn.innerText = "Compiling..."; btn.disabled = true;
            errBox.style.display = "none";

            try {
                const res = await fetch('/compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: editor.getValue(), project_id: projectId })
                });

                if (res.ok) {
                    const blob = await res.blob();
                    document.getElementById('preview').src = URL.createObjectURL(blob);
                    btn.innerText = "Recompile";
                } else {
                    const data = await res.json();
                    btn.innerText = "Failed";
                    errBox.innerText = `Line ${data.line}: ${data.message}`;
                    errBox.style.display = "block";
                }
            } catch (e) { alert("Server Error"); }
            finally { btn.disabled = false; }
        }
        refreshFileList();
    </script>
</body>
</html>